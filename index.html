<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FedeAnalytics - SALGA Ontology Viewer (Offline)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Cytoscape.js CDN -->
  <script src="https://unpkg.com/cytoscape@3.23.0/dist/cytoscape.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, Helvetica, sans-serif; background: #0f1720; color: #e6eef8; }
    #cy { width: 100%; height: calc(100% - 80px); display:block; }
    header { height: 80px; display:flex; align-items:center; padding: 12px 20px; gap:12px; background: linear-gradient(90deg,#071028,#0b1b2b); box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    .brand { display:flex; flex-direction:column; }
    .title { font-size:18px; font-weight:700; color: #bfe1ff; }
    .subtitle { font-size:12px; color: #9fb8d6; }
    .controls { margin-left:auto; display:flex; gap:8px; }
    button { background:#1f6feb; color:white; border: none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    button.secondary { background:#00a88b; }
    .legend { padding:8px 12px; background: rgba(255,255,255,0.03); border-radius:6px; }
    .legend-item { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .dot { width:14px; height:14px; border-radius:50%; display:inline-block; }
    .info { font-size:12px; color:#cfe6ff; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="title">FedeAnalytics — SALGA Ontology Viewer (Offline)</div>
      <div class="subtitle">Interactive, no-auth HTML viewer — embed this in your RFQ submission</div>
    </div>
    <div class="controls">
      <button id="zoomFit">Fit</button>
      <button id="exportPng" class="secondary">Export PNG</button>
      <button id="exportJson">Download JSON</button>
    </div>
  </header>

  <div id="cy"></div>

  <div style="position:fixed; right:12px; top:100px; width:240px;">
    <div class="legend">
      <div style="font-weight:700; margin-bottom:6px;">Legend</div>
      <div class="legend-item"><span class="dot" style="background:#2c6cf4"></span><span class="info">OntologyNode (id)</span></div>
      <div class="legend-item"><span class="dot" style="background:#00a88b"></span><span class="info">DataSource (name)</span></div>
      <div style="height:8px"></div>
      <div class="info">Use mouse drag to pan, scroll to zoom. Click nodes to see properties.</div>
    </div>
  </div>

<script>
/*
  ELEMENTS DATA
  - Replace the embedded JSON below if you want to use your own data.
  - The viewer expects "nodes" array and "edges" array.
  - Node entries: { data: { id: "node_x", label: "Label", oid: "RegPolicy", type:"Layer" }, classes: "ontology" }
  - DataSource entries: { data: { id: "ds_x", label: "StatsSA...", dsid:"DS3", category:"External" }, classes: "datasource" }
  - Edge entries: { data: { id: "e_1", source: "node_RegPolicy", target: "node_TariffRules", label:"HAS_SUBDOMAIN" } }
*/

/* ---------- SAMPLE / AUTO-EMBEDDED ONTOLOGY DATA ---------- */
/* If you already have your CSVs public, you can replace this JSON by embedding a fetched JSON.
   For RFQ submission, this file is self-contained and requires no network access. */
const elements = {
  "nodes": [
    {"data":{"id":"node_RegPolicy","label":"Regulatory & Policy Layer","oid":"RegPolicy","type":"Layer"},"classes":"ontology"},
    {"data":{"id":"node_TariffRules","label":"Tariff Rules","oid":"TariffRules","type":"Subdomain"},"classes":"ontology"},
    {"data":{"id":"node_CoSMethod","label":"Cost-of-Supply Methodology","oid":"CoSMethod","type":"Subdomain"},"classes":"ontology"},
    {"data":{"id":"node_OpsInfra","label":"Municipal Operations & Infrastructure Layer","oid":"OpsInfra","type":"Layer"},"classes":"ontology"},
    {"data":{"id":"node_Finance","label":"Finance & Cost Structures","oid":"Finance","type":"Layer"},"classes":"ontology"},
    {"data":{"id":"node_Opex","label":"OPEX","oid":"Opex","type":"Subdomain"},"classes":"ontology"},
    {"data":{"id":"node_Capex","label":"CAPEX","oid":"Capex","type":"Subdomain"},"classes":"ontology"},
    {"data":{"id":"node_CostAlloc","label":"Cost Allocations","oid":"CostAlloc","type":"Subdomain"},"classes":"ontology"},
    {"data":{"id":"ds_DS3","label":"StatsSA Census 2022","dsid":"DS3","category":"External"},"classes":"datasource"},
    {"data":{"id":"ds_DS1","label":"NSH Infrastructure & Service Delivery","dsid":"DS1","category":"External"},"classes":"datasource"}
  ],
  "edges": [
    {"data":{"id":"e1","source":"node_RegPolicy","target":"node_TariffRules","label":"HAS_SUBDOMAIN"}},
    {"data":{"id":"e2","source":"node_RegPolicy","target":"node_CoSMethod","label":"HAS_SUBDOMAIN"}},
    {"data":{"id":"e3","source":"node_OpsInfra","target":"node_Finance","label":"RELATES_TO"}},
    {"data":{"id":"e4","source":"node_Finance","target":"node_Opex","label":"HAS_SUBDOMAIN"}},
    {"data":{"id":"e5","source":"node_Finance","target":"node_Capex","label":"HAS_SUBDOMAIN"}},
    {"data":{"id":"e6","source":"node_Finance","target":"node_CostAlloc","label":"HAS_SUBDOMAIN"}},
    {"data":{"id":"e7","source":"node_TariffRules","target":"ds_DS1","label":"USES"}},
    {"data":{"id":"e8","source":"node_CostAlloc","target":"ds_DS1","label":"USES"}},
    {"data":{"id":"e9","source":"node_TariffRules","target":"ds_DS3","label":"USES"}
    }
  ]
};
/* ---------- END OF EMBEDDED DATA ---------- */

const cy = cytoscape({
  container: document.getElementById('cy'),
  elements: [].concat(
    elements.nodes.map(n => ({
      data: { id: n.data.id, label: n.data.label, oid: n.data.oid || null, dsid: n.data.dsid || null, type: n.data.type || null, category: n.data.category || null },
      classes: n.classes || ''
    })),
    elements.edges.map(e => ({
      data: { id: e.data.id, source: e.data.source, target: e.data.target, label: e.data.label }
    }))
  ),
  style: [
    {
      selector: 'node.ontology',
      style: {
        'background-color': '#2c6cf4',
        'label': 'data(oid)',
        'color': '#fff',
        'text-valign': 'center',
        'text-halign': 'center',
        'text-outline-color': '#103050',
        'text-outline-width': 4,
        'width': 48,
        'height': 48,
        'font-size': 10
      }
    },
    {
      selector: 'node.datasource',
      style: {
        'background-color': '#00a88b',
        'label': 'data(label)',
        'color': '#012d26',
        'text-valign': 'center',
        'text-halign': 'center',
        'width': 54,
        'height': 34,
        'shape': 'round-rectangle',
        'font-size': 9
      }
    },
    {
      selector: 'edge',
      style: {
        'width': 2,
        'curve-style': 'bezier',
        'target-arrow-shape': 'triangle',
        'line-color': '#888',
        'target-arrow-color': '#888',
        'label': 'data(label)',
        'font-size': 9,
        'text-background-opacity': 1,
        'text-background-color': '#fff',
        'text-background-padding': 3,
        'text-background-shape': 'roundrectangle'
      }
    }
  ],
  layout: {
    name: 'dagre',
    rankDir: 'TB',
    nodeSep: 50,
    edgeSep: 10,
    rankSep: 60
  },
  wheelSensitivity: 0.2
});

// click node to show details
cy.on('tap', 'node', function(evt){
  const node = evt.target;
  const props = node.data();
  alert('Node properties:\\n' + JSON.stringify(props, null, 2));
});

// Fit control
document.getElementById('zoomFit').addEventListener('click', function() { cy.fit(20); });

// Export PNG
document.getElementById('exportPng').addEventListener('click', function() {
  const png64 = cy.png({ full: true, scale: 2 });
  const a = document.createElement('a');
  a.href = png64;
  a.download = 'ontology_graph.png';
  document.body.appendChild(a);
  a.click();
  a.remove();
});

// Download JSON
document.getElementById('exportJson').addEventListener('click', function() {
  const data = {
    nodes: cy.elements('node').map(n => n.data()),
    edges: cy.elements('edge').map(e => e.data())
  };
  const a = document.createElement('a');
  a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data, null, 2));
  a.download = 'ontology_export.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
});
</script>
</body>
</html>

